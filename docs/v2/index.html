<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Horde Calc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="icon" type="image/png" href="horde-logo-250.png"/>

    <style>
        .blockie {
            border: 1px solid black;
            border-radius: 5px;
        }

        #main-container {
            padding: 5px;
        }

        .form-container {
            padding: 1.5rem;
            margin-right: 0;
            margin-left: 0;
            border-width: 1px;
            border-top-left-radius: .25rem;
            border-top-right-radius: .25rem;
            margin: 1rem -.75rem 0;
            border: solid #dee2e6;
        }

        .standard-size-plot{
            width:95%; height: 500px;
        }

        body {
            background-color: #16191d;
            color: #f5f5f5;
        }

        .horde-default-background {
            background-color: #16191d;
        }

        .btn-horde:hover {
            background-color: #17C139;
            border-color: #17C139;
        }

        .horde-purple-background {
            background-color: #6C0EB6;
        }

        .horde-purple-border {
            border-color: #6C0EB6;
        }

        .horde-white-text {
            color: #dee2e6;
        }

        .btn-grad
        {
            background:-webkit-gradient(linear,right bottom,left top,from(#f5f97f),color-stop(65%,#17c139),to(#17c139));
            background:linear-gradient(to left top,#f5f97f 0,#17c139 65%,#17c139);
            color:#000;
            border:none
        }
        .btn-grad:hover{
            color:#e2e2e2
        }

        .nav-tabs {
            border-bottom: 1px solid #6C0EB6;
        }

        .nav-link {
            color: #dee2e6 !important;
            border-color: #6C0EB6 !important;
            cursor: pointer;
        }

        .nav-tabs .nav-link:hover {
            color: #dee2e6;
            background-color: #6C0EB6;
        }

        .tab-active {
            background:-webkit-gradient(linear,right bottom,left top,from(#f5f97f),color-stop(65%,#17c139),to(#17c139)) !important;
            background:linear-gradient(to left top,#f5f97f 0,#17c139 65%,#17c139) !important;
            color:#000 !important;
            border:none;
            cursor: pointer;
        }

        .tab-active:hover {
            color: #dee2e6 !important;
        }

        .template-cards-container {
            display: flex;
            flex-direction: row;
        }

        .template-card {
            width: 13rem;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-clip: border-box;
            border: 2px solid rgba(0,0,0,.125);
            border-radius: 1.5rem;
            border-color: #6C0EB6;
            margin-right: 1rem;
        }

        .template-card {
            padding: 0.3rem;
        }

        .template-card .card-header {
            font-size: 1.2em;
        }

        .template-card .template-card-body {
            padding-left: 2rem;
            padding-bottom: 0.5rem;
        }


        .template-card .template-card-body .card-row {
            width: 90%;
            display: block;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #6C0EB6;
            margin-bottom: 0.5rem;
            padding-left: 0.8rem;
        }
        .template-card .template-card-body .card-row .card-row-number{
            font-size: 1.2em;
        }

        .template-card .template-card-pencil {
            position: absolute;
            top: 3%;
            right: 2%;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 6px 4px 6px;
            border-radius: 1rem;
            user-select: none; /* Standard */
        }

        .template-card .template-card-pencil:hover {
            background-color: #6C0EB6;
        }

        .template-card .template-card-trash {
            position: absolute;
            top: 20%;
            right: 2%;
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 1rem;
            user-select: none; /* Standard */
        }

        .template-card .template-card-trash:hover {
            background-color: #6C0EB6;
        }

        #ptem-outer-body {
            max-width: 35rem;
        }

        .ptem-datepicker {
            width: 10rem;
        }

        .ptem-plotcount {
            width: 5rem;
            text-align: right;
        }

        .ptem-plot-group {
            margin-bottom: 0.3rem;
        }
    </style>
</head>
<body class="horde-white-text" style="overflow-y:scroll;">
    <div class="container" id="main-container">
        <!--
        <div class="blockie">
            Create plots template
            <br>
            Add plots
            <br>:w

            <label>Expiry date</label>
            <input id="add_plots_expiry_date" type="date"/>
            <input id="add_plots_count" type="number" value="1"/>
            <button onclick="onAddPlotsClicked()">Add plots</button>

        </div>
        -->

        <!-- Export templates --> <!-- TODO -->
        <!-- Import templates --> <!-- TODO -->

        <!-- <button onclick="">Calculate</button> -->
        <br>
        <img alt="logo" src="horde-logo-250.png"/>
        <br>
        <div>
            Link to github
            <a class="horde-white-text" href="https://github.com/anonuser123abc/horde-calculator">https://github.com/anonuser123abc/horde-calculator</a>
        </div>
        <br>
        <div>
            <div>
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <span id="calculator-tab-btn" onclick="openTab('calculator-tab')" class="nav-link" aria-current="page" href="#">Calculator</span>
                    </li>
                    <li class="nav-item">
                        <span id="templates-tab-btn" onclick="openTab('templates-tab')" class="nav-link">Templates</span>
                    </li>
                    <li class="nav-item">
                        <span id="simple-calculator-tab-btn" onclick="openTab('simple-calculator-tab')" class="nav-link tab-active">Simple calculator</span>
                    </li>
                </ul>
            </div>
            <br>
            <div style="display: none" id="calculator-tab">
                <h3>
                    Calculator
                </h3>
            </div>
            <div style="display: none" id="templates-tab">
                <div>
                    <h3 style="display: inline-block">
                        Templates
                    </h3>
                    <button onclick="openCreatePTEM()" style="margin-left: 0.7rem; margin-bottom: .5rem;" class="btn btn-primary btn-grad">+ New</button>
                </div>
                <div class="template-cards-container" id="templates-tab-container">
                    <div style="display: none"  class="template-card">  <!-- just a template for testing styles, change display style to play with -->
                        <div class="card-header">
                            Wishful Thinking
                        </div>
                        <div class="card-body">
                            <span class="card-row"><span class="card-row-number">8</span> plots</span>
                            <span class="card-row"><span class="card-row-number">3</span> NFTs</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="simple-calculator-tab" >
                <h3>
                    Simple calculator - it supposes plots were created today
                </h3>
                <div class="form-container horde-purple-border">
                    <form onsubmit="return false" >
                        <label class="form-label" for="scalc_num_of_plots">How many plots:</label><br>
                        <input onchange="testch()" class="form-control" value="1" type="number" id="scalc_num_of_plots" style="width: 20%"/>
                        <br>
                        <label class="form-label" for="scalc_num_of_claimable">How many claimable tokens you have at the moment:</label>
                        <br>
                        <input class="form-control" value="0" type="number" id="scalc_num_of_claimable" style="width: 20%" step="0.001"/>
                        <br>
                        <label class="form-label" for="scalc_num_of_days_in_future">Duration in future:</label>
                        <br>
                        <input class="form-control" value="500" type="number" id="scalc_num_of_days_in_future" style="width: 20%"/>
                        <br>
                        <button onclick="runCalculation()" class="btn btn-primary btn-grad">Compound &nbsp:)</button> (scroll down)
                    </form>
                </div>
                <br>
                <div style="padding: 5px; display: none" id="results">
                    <h1 style="padding-left: 20px">Plot Graph</h1>
                    <br>
                    <div class="standard-size-plot" id="activePlotsGraphContainer">
                        <canvas id="activePlotsGraph"></canvas>
                    </div>
                    <br>
                    <br>
                    <div id="monthly-results">
                        <h3>Monthly printouts</h3>
                        <div id="monthly-results-raw"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- MODALS -->

    <!-- Plot Template Editor Modal -->
    <div class="horde-modal modal fade" id="plot-template-editor-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div id="ptem-outer-body" class="modal-dialog">
            <div class="horde-default-background modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ptem-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="ptem-body" class="modal-body">
                    Name <input id="ptem-name" style="font-size: 14px" maxlength="18">
                    <br>
                    <br>
                    <div>
                    Plot groups
                        <br>
                        <div style="border-bottom: 1px solid white;">
                            <span style="font-size: 1.2rem;">#. &nbsp</span> <span style="width: 5rem; display: inline-block; text-align: center;">plot count</span> &nbsp <span style="width: 10rem; display: inline-block; text-align: center;">creation date</span> &nbsp <span style="width: 10rem; display: inline-block; text-align: center;">decay date</span>
                        </div>
                        <br>
                        <div style="border-bottom: 1px solid white;">
                            <!-- Wow such empty -->
                            <div id="ptem-plot-groups">
                            </div>
                            <br>
                            <button onclick="addEmptyPlotGroupToPtem()" style="margin-left: 0.7rem; margin-bottom: .5rem;" class="btn btn-primary btn-grad">+ Another Plot Group</button>
                        </div>
                    </div>
                    Total plots: <span id="ptem-total-plots">1</span>
                    <br>
                    Total NFTs: <span id="ptem-total-nfts">0</span>
                </div>
                <span id="ptem-error" style="color: red; display:none"></span>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button onclick="onPtemSaveClick()" id="ptem-save-btn" type="button" class="btn btn-primary btn-grad"></button>
                </div>
            </div>
        </div>
    </div>



</body>
</html>

<script>
    let GLOBAL_DATA = {
        'templates': {
            //keyed by name
        },
    };

    const LIVE_WALLET_TEMPLATE_NAME = 'Live Wallet'
    const LIVE_WALLET_TEMPLATE_NAME_EDITED = 'Live Wallet Edited'
    const BE_CREATIVE_NAME = '-- be creative --';

    let FORBIDDEN_NAMES = {};
    FORBIDDEN_NAMES[LIVE_WALLET_TEMPLATE_NAME] = 1;
    FORBIDDEN_NAMES[LIVE_WALLET_TEMPLATE_NAME_EDITED] = 1;
    FORBIDDEN_NAMES[BE_CREATIVE_NAME] = 1;

    const PLOT_DECAY = 300;

    const PTEM_MODE_CREATE = 'create';
    const PTEM_MODE_EDIT = 'edit';
    const PTEM_MODE_EDIT_LIVE_WALLET = 'edit_live_wallet';


    let currentTab = 'simple-calculator-tab';
    let templateFromInput = null;
    let plotTemplateEditorModal = new bootstrap.Modal(document.getElementById('plot-template-editor-modal'))
    let ptemGroupsDiv = document.getElementById('ptem-plot-groups');
    let ptemName = document.getElementById('ptem-name')
    let ptemTotalPlots = document.getElementById('ptem-total-plots')
    let ptemTotalNfts = document.getElementById('ptem-total-nfts')
    let ptemSaveButton = document.getElementById('ptem-save-btn')
    let ptemError = document.getElementById('ptem-error')
    let templatesTabContainer = document.getElementById('templates-tab-container')
    let ptemMode = null;

    let currentPtemTemplate = {}
    //openCreatePTEM();

    function openCreatePTEM() {
        document.getElementById('ptem-title').innerText = "Create new template";
        currentPtemTemplate = createPlotTemplate([
            createPlotGroupFromCreation(new Date(), 5),
            createPlotGroupFromCreation(copyAndAddDays(new Date(), 5), 1),
            createPlotGroupFromCreation(copyAndAddDays(new Date(), 15), 1),
        ], BE_CREATIVE_NAME)
        preparePtem(currentPtemTemplate)
        ptemSaveButton.innerText = "Create Template"
        ptemMode = PTEM_MODE_CREATE;
        ptemName.disabled = false
        plotTemplateEditorModal.show()
    }

    function openWalletPTEM() {
        document.getElementById('ptem-title').innerText = "Edit live-wallet template (not permanent)";
        currentPtemTemplate = clone(templateFromInput)
        preparePtem(currentPtemTemplate)
        ptemSaveButton.innerText = "Update Live Template (temporarily)"
        ptemMode = PTEM_MODE_EDIT_LIVE_WALLET;
        ptemName.disabled = true
        plotTemplateEditorModal.show()
    }

    function openEditPTEM(template) {
        document.getElementById('ptem-title').innerText = "Edit " + template.name + " template";
        currentPtemTemplate = clone(template)
        preparePtem(currentPtemTemplate)
        ptemSaveButton.innerText = "Update"
        ptemMode = PTEM_MODE_EDIT;
        ptemName.disabled = false
        plotTemplateEditorModal.show()
    }

    function openPTEM(name) {
        console.log("huhu")
        if(name === LIVE_WALLET_TEMPLATE_NAME || name === LIVE_WALLET_TEMPLATE_NAME_EDITED) {
            openWalletPTEM();
        } else {
            openEditPTEM(GLOBAL_DATA['templates'][name]);
        }
    }

    function deleteTemplate(name) {
        if(name in GLOBAL_DATA.templates) {
            delete GLOBAL_DATA.templates[name]
            renderTemplates()
        }
    }

    function preparePtem(template) {
        ptemError.innerText = '';
        ptemError.style.display = 'none'
        ptemGroupsDiv.innerHTML = ''
        ptemName.value = template.name;
        ptemTotalPlots.innerText = template.plotCount;
        ptemTotalNfts.innerText = template.nftCount;
        template.plotGroups.forEach(
            (item, i) => {
                addPlotGroupToPtem(i + 1, item)
            }
        )
    }

    function onPtemSaveClick() {
        if(ptemMode === PTEM_MODE_CREATE || ptemMode === PTEM_MODE_EDIT) {

            if(ptemName.value in FORBIDDEN_NAMES) {
                ptemError.innerText = 'That name is not allowed! Try a different one'
                ptemError.style.display = 'block'
                return;
            }

            //if its an edit and the name is changed, first remove the old key
            if(ptemMode === PTEM_MODE_EDIT && ptemName.value !== currentPtemTemplate.name) {
                delete GLOBAL_DATA.templates[currentPtemTemplate.name]
                currentPtemTemplate.name = ptemName.value;
            }

            currentPtemTemplate.name = ptemName.value;
            GLOBAL_DATA.templates[currentPtemTemplate.name] = clone(currentPtemTemplate);
            renderTemplates();

        } else if(ptemMode === PTEM_MODE_EDIT_LIVE_WALLET) {
            currentPtemTemplate.name = LIVE_WALLET_TEMPLATE_NAME_EDITED
            templateFromInput = clone(currentPtemTemplate)
            renderTemplates();
        }

        plotTemplateEditorModal.hide()
        currentPtemTemplate = null;
    }

    function renderTemplates() {
        templatesTabContainer.innerHTML = '';
        if(templateFromInput !== null) {
            //plotTemplate, isLiveTemplate, isLiveTemplateEdited, generateEditPencil, generateDeleteButton
            templatesTabContainer.insertAdjacentHTML(
                'beforeend',
                generateTemplateUICard(templateFromInput, true, templateFromInput.name === LIVE_WALLET_TEMPLATE_NAME_EDITED, true, false)
            )
        }

        for(let templateName in GLOBAL_DATA.templates) {
            let template = GLOBAL_DATA.templates[templateName]
            templatesTabContainer.insertAdjacentHTML(
                'beforeend',
                generateTemplateUICard(template, false, false, true, true)
            )
        }
    }

    function addEmptyPlotGroupToPtem() {
        let date = copyAndAddDays(findNewestCreateDateInPlotTemplate(currentPtemTemplate), 1)
        let plotCount = 1;
        let newPlotGroup = createPlotGroupFromCreation(date, plotCount)
        addPlotGroupToPtem(currentPtemTemplate.plotGroups.length + 1, newPlotGroup)
        currentPtemTemplate.plotGroups.push(newPlotGroup)
        currentPtemTemplate.plotCount = countPlots(currentPtemTemplate.plotGroups)

        ptemTotalPlots.innerText = currentPtemTemplate.plotCount.toString();
        ptemTotalNfts.innerText = currentPtemTemplate.nftCount.toString();
    }

    function addPlotGroupToPtem(num, plotGroup) {
        ptemGroupsDiv.insertAdjacentHTML('beforeend', generatePlotGroupEditUI(num, plotGroup.count, dateOnlyString(plotGroup.createdAt), dateOnlyString(plotGroup.expiresAt)))
    }

    function findNewestCreateDateInPlotTemplate(template) {
        let newestDate = new Date()
        template.plotGroups.forEach(
            (item, i) => {
                if(item.createdAt > newestDate) {
                    newestDate = item.createdAt
                }
            }
        )

        return newestDate
    }

    function openTab(tabId) {
        if(tabId === currentTab) {
            return;
        }
        document.getElementById(tabId).style.display = 'block';
        document.getElementById(tabId + "-btn").classList.add('tab-active');

        document.getElementById(currentTab).style.display = 'none';
        document.getElementById(currentTab + "-btn").classList.remove('tab-active');

        currentTab = tabId;
    }

    function ptemPlotCountChanged(inputElement) {
        let plotGroupIndex = parseInt(inputElement.parentNode.dataset.pgroupid) - 1;
        currentPtemTemplate.plotGroups[plotGroupIndex].count = parseInt(inputElement.value)
        currentPtemTemplate.plotCount = countPlots(currentPtemTemplate.plotGroups)

        ptemTotalPlots.innerText = currentPtemTemplate.plotCount.toString();
        ptemTotalNfts.innerText = currentPtemTemplate.nftCount.toString();
    }

    function ptemPlotCreatedAtChanged(inputElement) {
        let plotGroupIndex = parseInt(inputElement.parentNode.dataset.pgroupid) - 1;

        let newCreatedAtDate = new Date(inputElement.value);
        let newDecayDate = copyAndAddDays(newCreatedAtDate, PLOT_DECAY);
        let decayAtElement = inputElement.parentNode.querySelectorAll('.plot-decay-at')[0];
        decayAtElement.value = dateOnlyString(newDecayDate);

        currentPtemTemplate.plotGroups[plotGroupIndex].createdAt = newCreatedAtDate;
        currentPtemTemplate.plotGroups[plotGroupIndex].expiresAt = newDecayDate;
    }

    function ptemPlotExpiresAtChanged(inputElement) {
        let plotGroupIndex = parseInt(inputElement.parentNode.dataset.pgroupid) - 1;

        let newDecayDate = new Date(inputElement.value);
        let newCreatedAtDate = copyAndAddDays(newDecayDate, -PLOT_DECAY);
        let createdAtElement = inputElement.parentNode.querySelectorAll('.plot-created-at')[0];
        createdAtElement.value = dateOnlyString(newCreatedAtDate);

        currentPtemTemplate.plotGroups[plotGroupIndex].createdAt = newCreatedAtDate;
        currentPtemTemplate.plotGroups[plotGroupIndex].expiresAt = newDecayDate;
    }

    function generatePlotGroupEditUI(num, plotCount, createDate, decayDate) {
        let numString = num.toString();
        if(num < 10) {
            numString = '00' + num.toString();
        } else if (num < 100) {
            numString = '0' + num.toString();
        }
        return  `
            <div data-pgroupid="${num}" class="ptem-plot-group">
                <span style="font-size: 1.2rem;">${numString}. &nbsp</span> <input min="1" onchange="ptemPlotCountChanged(this)" type="number" class="ptem-plotcount" value="${plotCount}"/> - <input onchange="ptemPlotCreatedAtChanged(this)" class="plot-created-at ptem-datepicker" type="date" value="${createDate}"/> - <input onchange="ptemPlotExpiresAtChanged(this)" class="plot-decay-at ptem-datepicker"  type="date" value="${decayDate}"/>
            </div>
        `;
    }

    function copyAndAddDays(initialDate, n) {
        let myNewDate = new Date(initialDate);
        myNewDate.setDate(myNewDate.getDate() + n);
        return myNewDate;
    }

    function assureDateValidity(d) {
        let isValid = d instanceof Date && !isNaN(d);
        if(!isValid) {
            alert('Invalid date!')
            throw new Error('Invalid date!');
        }
    }

    function alertObj(obj) {
        alert(JSON.stringify(obj, null, 2))
    }

    function onAddPlotsClicked() {
        let expiryDate = new Date(document.getElementById('add_plots_expiry_date').value)
        assureDateValidity(expiryDate)
        let count = parseInt(document.getElementById('add_plots_count').value)
        let plotGroup = createPlotGroupFromExpiration(expiryDate, count)
        alertObj(plotGroup);
    }

    function createPlotGroupFromExpiration(expireDate, count) {
        return {
            'createdAt': copyAndAddDays(expireDate, -PLOT_DECAY),
            'expiresAt': expireDate,
            'count': count
        }
    }

    function createPlotGroupFromCreation(creationDate, count) {
        return {
            'createdAt': creationDate,
            'expiresAt': copyAndAddDays(creationDate, PLOT_DECAY),
            'count': count
        }
    }

    function createSettingsTemplate(
        //todo: add more params to make the calc more generalized.. reward amount (def 0.25), reward frequency in seconds (def 21600),
        // plot longevity in days (def 300), token price (def $100), sell tax (def 10%) etc..
        name,
        compoundingToSellRatio,
        useSmartCompounding,
        avgPlotCreationDelayInDays
    ) {
        return {
            'name': name,
            'compoundingToSellRatio': compoundingToSellRatio,
            'useSmartCompounding': useSmartCompounding, //means that we first claim to compound, and only then sell
            'avgPlotCreationDelayInHours': avgPlotCreationDelayInDays,
        }
    }

    function createPlotTemplate(plotGroups, name) {
        return {
            'plotGroups': plotGroups,
            'name': name,
            'plotCount': countPlots(plotGroups),
            'nftCount': 0
        }
    }

    function smartRound(num, decimalPrecision) { //god i hate JS
        let mult = 10 ** decimalPrecision;
        return Math.round((num + Number.EPSILON) * mult) / mult;
    }

    function dateOnlyString(date) { //god i hate JS even more
        return new Date(date.getTime() - (date.getTimezoneOffset() * 60000 ))
            .toISOString()
            .split("T")[0];
    }

    function clone(obj) { //.. makes me happy i dont usually work in JS
        if (obj === null || typeof (obj) !== 'object' || 'isActiveClone' in obj)
            return obj;

        if (obj instanceof Date)
            return new Date(obj); //or new Date(obj);
        else
            var temp = obj.constructor();

        for (var key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                obj['isActiveClone'] = null;
                temp[key] = clone(obj[key]);
                delete obj['isActiveClone'];
            }
        }
        return temp;
    }

    function calculate(plotTemplate, settingsTemplate, startFromDate, calculateDays, claimable) {
        let dateIterator = new Date(startFromDate);

        let activePlots = Object.assign({}, plotTemplate);
        let decayedPlotGroups = [];
        let month = 69; //crazy value to make it print once as soon as it starts
        let results = ''; //
        let calculatedData = [];


        for(let i = 0; i < calculateDays; i++) {
            let isLastLoop = (i + 1) === calculateDays;
            let survivingGroups = [];
            activePlots.plotGroups.forEach(item => {
                claimable += (0.1 * item.count)

                if(dateIterator < item.expiresAt) {
                    survivingGroups.push(item)
                } else {
                    decayedPlotGroups.push(item);
                }
            })

            let decayedPlotCount = countPlots(decayedPlotGroups);
            let activePlotCount = countPlots(activePlots.plotGroups);
            let dailyHordeGeneration = smartRound(activePlotCount * 0.1, 2);
            let dailyDollarGeneration = smartRound(dailyHordeGeneration * 100, 2);
            let dateOnlyAsString = dateOnlyString(dateIterator);
            //print every month (or last date)
            if(month !== dateIterator.getMonth() ||  isLastLoop) {
                month = dateIterator.getMonth();
                if(isLastLoop) {
                    results += "<h4>Result on last day</h4>" + "<br>";
                }
                results += "State at  " + dateOnlyAsString + "<br>";
                //results += "&nbsp&nbsp&nbsp&nbspClaimable: " + smartRound(claimable, 2).toString() + "<br>"; //makes no sense to print in a monthly printout
                results += "&nbsp&nbsp&nbsp&nbspDay: " + (i + 1).toString() + "<br>";
                results += "&nbsp&nbsp&nbsp&nbspPlots: " + activePlotCount.toString() + "<br>";
                results += "&nbsp&nbsp&nbsp&nbspDaily token generation: " + smartRound(dailyHordeGeneration, 2) + "<br>";
                results += "&nbsp&nbsp&nbsp&nbspDaily dollar generation: $" + smartRound(dailyDollarGeneration, 2).toString() + "<br>";
                results += "&nbsp&nbsp&nbsp&nbspDecayed plots: " + decayedPlotCount + "<br>";
                results += "<br>";

            }

            //if we have enough to create a plot(s), we create
            let plotsToCreate = 0;
            while(claimable >= 10) {
                claimable -= 10;
                plotsToCreate++;
            }

            if(plotsToCreate !== 0) {
                survivingGroups.push(
                    createPlotGroupFromCreation(
                        new Date(dateIterator),
                        plotsToCreate
                    )
                )
            }

            if(survivingGroups.length === 0) {
                results += "On day " + (i + 1).toString() + " you've run out of plots, because you sold too much!"
                break;
            }

            calculatedData.push(
                {
                    day: (i + 1),
                    date: dateOnlyAsString,
                    activePlots: activePlotCount,
                    decayedPlots: decayedPlotCount,
                    dailyHorde: dailyHordeGeneration,
                    dailyDollar: dailyDollarGeneration
                }
            )
            activePlots.plotGroups = survivingGroups;
            dateIterator = copyAndAddDays(dateIterator, 1);
        }

        document.getElementById("monthly-results-raw").innerHTML = results

        return calculatedData;
    }

    function countPlots(plotGroups) {
        let sum = 0;
        for(let i = 0; i < plotGroups.length; i++) {
            sum += plotGroups[i].count;
        }

        return sum;
    }

    let ACTIVE_PLOT_CHART = null;

    function runCalculation() {

        let todayDate = new Date();
        let decayDate = copyAndAddDays(todayDate, PLOT_DECAY);

        let numOfPlots = parseInt(document.getElementById("scalc_num_of_plots").value)
        let numOfClaimable = parseInt(document.getElementById("scalc_num_of_claimable").value)
        let numOfDaysInFuture = parseInt(document.getElementById("scalc_num_of_days_in_future").value)

        let settingsTemplate = createSettingsTemplate(
            'justname',
            1,
            true,
            3
        )

        let plotTemplate = createPlotTemplate([createPlotGroupFromExpiration(decayDate, numOfPlots)], 'simple');
        let calculatedData = calculate(plotTemplate, settingsTemplate, todayDate, numOfDaysInFuture, numOfClaimable)

        plotPlotGraph(calculatedData);
        document.getElementById("results").style.display = 'block';

        /*
        let settingsTemplate = createSettingsTemplate(
            'justname',
            1,
            true,
            12
        )

        let plotTemplate = createPlotTemplate([createPlotGroupFromExpiration(new Date('1/16/2023'), 3)]);

        calculate(plotTemplate, settingsTemplate, new Date('03/22/2022'), 720)*/
    }

    function plotPlotGraph(calculatedData) { //plotPlot lmao
        if (ACTIVE_PLOT_CHART !== null) {
            ACTIVE_PLOT_CHART.destroy()
        }
        ACTIVE_PLOT_CHART = plotGraphFromCalcData(document.getElementById('activePlotsGraph'), calculatedData,
            [{
                label: 'Active Plots',
                data: calculatedData,
                borderColor:'#17C139',
                borderWidth: 1,
                pointBorderWidth: 1,
                pointRadius: 1,
                parsing: {
                    xAxisKey: 'date',
                    yAxisKey: 'activePlots'
                }
            }, {
                label: 'Decayed Plots',
                data: calculatedData,
                borderColor:'#6C0EB6',
                borderWidth: 1,
                pointBorderWidth: 1,
                pointRadius: 1,
                parsing: {
                    xAxisKey: 'date',
                    yAxisKey: 'decayedPlots'
                }
            }]);
    }

    function plotGraphFromCalcData(ctx, calculatedData, datasets) {
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                plugins: {  // 'legend' now within object 'plugins {}'
                    legend: {
                        labels: {
                            color: "#dee2e6",  // not 'fontColor:' anymore
                            // fontSize: 18  // not 'fontSize:' anymore
                            font: {
                                size: 12 // 'size' now within object 'font {}'
                            }
                        }
                    }
                },
                responsive:true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    axis: 'x'
                },
                scales: {
                    y: {
                        beginAtZero: false
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    },
                }
            }
        });

        return chart;
    }

    function isJson(item) {
        item = typeof item !== "string"
            ? JSON.stringify(item)
            : item;

        try {
            item = JSON.parse(item);
        } catch (e) {
            return false;
        }

        return typeof item === "object" && item !== null;
    }

    function generateTemplateUICard(plotTemplate, isLiveTemplate, isLiveTemplateEdited, generateEditPencil, generateDeleteButton) {
        let editPencilHTML = '';
        if(generateEditPencil) {
            editPencilHTML = `
                <span onclick="openPTEM('${plotTemplate.name}')" class="template-card-pencil"> 🖉 </span>
            `;
        }

        let deleteButtonHTML = '';
        if(generateDeleteButton) {
            deleteButtonHTML = `
                <span onclick="deleteTemplate('${plotTemplate.name}')" class="template-card-trash">🗑</span>
            `;
        }

        let name = plotTemplate.name;
        if(isLiveTemplate) {
            let text = '• LIVE';
            if(isLiveTemplateEdited) {
                text = '• LIVE (edited) ';
            }
            name = `<span style="padding: 2px 12px 2px 8px; background-color: #6C0EB6">${text}</span>`;
        }

        return `
            <div class="template-card">
                ${editPencilHTML}
                ${deleteButtonHTML}
                <div class="card-header">
                    ${name}
                </div>
                <div class="template-card-body">
                    <span class="card-row"><span class="card-row-number">${plotTemplate.plotCount}</span> plots</span>
                    <span class="card-row"><span class="card-row-number">${plotTemplate.nftCount}</span> NFTs</span>
                </div>
        </div>`;
    }

    function readInput(rawQueryParams, startingValues) {
        try {
            if ('plots' in rawQueryParams) {
                let decodedString = atob(rawQueryParams.plots);
                if (isJson) {
                    let plotsDecayList = JSON.parse(decodedString)
                    let countByDate = {}
                    let totalCount = 0;
                    plotsDecayList.forEach((x, i) => {
                        if (!(x in countByDate)) {
                            countByDate[x] = 0
                        }
                        countByDate[x]++
                        totalCount++;
                    })

                    let plotGroups = []
                    for(const dateString in countByDate) {
                        const decayDate = new Date(dateString)
                        const count = countByDate[dateString];
                        plotGroups.push(createPlotGroupFromExpiration(decayDate, count))
                    }

                    startingValues.plots = plotGroups
                    startingValues.plotsCount = totalCount
                    templateFromInput = createPlotTemplate(plotGroups, LIVE_WALLET_TEMPLATE_NAME)
                    renderTemplates();
                    //templatesTabContainer.insertAdjacentHTML('beforeend', "<span>Detected live wallet template</span><br><br>")
                    //templatesTabContainer.insertAdjacentHTML('beforeend', generateTemplateUICard(templateFromInput, true, false, true, false))
                }
            }
            if ('claimable' in rawQueryParams) {
                startingValues.claimable = parseFloat(rawQueryParams.claimable)
            }
        } catch (e) {
            console.log(e)
        }

        return startingValues;
    }


    let rawQueryParams = {
        'v': 0, //placeholders
        'plots': [],
        'plotsCount': [],
        'claimable': 0.0
    }
    location.search.substr(1).split("&").forEach(function(item) {rawQueryParams[item.split("=")[0]] = item.split("=")[1]})

    let defaultPlotsCount = 1;
    let defaultPlots = [createPlotGroupFromCreation(new Date(), defaultPlotsCount)];
    let defaultClaimable = 0;
    let startingValues = {
        plots: defaultPlots,
        claimable: defaultClaimable,
        plotsCount: defaultPlotsCount,
    }

    startingValues = readInput(rawQueryParams, startingValues);

    document.getElementById("scalc_num_of_plots").value = startingValues.plotsCount;
    document.getElementById("scalc_num_of_claimable").value = startingValues.claimable;
    runCalculation();

    openTab("templates-tab")


</script>
